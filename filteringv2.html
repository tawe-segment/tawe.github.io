<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <title>Filtering: Dest Middleware</title>
    <script>
        !function () {
            var analytics = window.analytics = window.analytics || []; if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice."); else {
                analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "once", "off", "on", "addSourceMiddleware", "addIntegrationMiddleware", "setAnonymousId", "addDestinationMiddleware"]; analytics.factory = function (e) { return function () { var t = Array.prototype.slice.call(arguments); t.unshift(e); analytics.push(t); return analytics } }; for (var e = 0; e < analytics.methods.length; e++) { var key = analytics.methods[e]; analytics[key] = analytics.factory(key) } analytics.load = function (key, e) { var t = document.createElement("script"); t.type = "text/javascript"; t.async = !0; t.src = "https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js"; var n = document.getElementsByTagName("script")[0]; n.parentNode.insertBefore(t, n); analytics._loadOptions = e }; analytics._writeKey = "kxu54FZnPqGFfWYgOhHB4yMfph1ZWSWK";; analytics.SNIPPET_VERSION = "4.15.3";
                analytics.load("kxu54FZnPqGFfWYgOhHB4yMfph1ZWSWK");
                analytics.page()
            }
        }();
    </script>
</head>
<script>

    //Middleware function
    function fbMW() {
        const excludedEvent = [
            'Clicked Buy Now Button',
            'Added Payment Details'
        ];

        var fbMW1 = async function ({ payload, next, integration }) {

            //check if the event name is not contained in excludedEvent array and send downstream to facebook pixel
            //if true, the event is dropped completely for Facebook only.
            if (excludedEvent.includes(payload.obj.event) = false) {
                next(payload); //deliver the payload
            }
        }

        //Activates the middleware for Facebook destination only
        analytics.addDestinationMiddleware('Facebook Pixel', [fbMW1]);

        //Declared events
        //event 1
        analytics.track("Logged In", {
            email: 'xyz@segment.com'
        });

        //event 2 - should not appear on pixel
        analytics.track("Clicked Buy Now Button", {
            email: 'xyz@segment.com'
        });

        //event 3 - should not appear on pixel
        analytics.track("Added Payment Details", {
            email: 'xyz@segment.com',
            value: 20.5
        });

        //event 4
        analytics.track("Order Completed", {
            email: 'xyz@segment.com',
            value: 20.5,
            order_id: 'xyz1234567890xyz'
        });

    }

</script>
</head>

<body>
    <p>Just Another Page: Filtering using Destination Middleware</p>
</body>

</html>