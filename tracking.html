<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <title>UTM Trait with Middleware</title>
    <script>
        !function () {
            var analytics = window.analytics = window.analytics || []; if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice."); else {
                analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "once", "off", "on", "addSourceMiddleware", "addIntegrationMiddleware", "setAnonymousId", "addDestinationMiddleware"]; analytics.factory = function (e) { return function () { var t = Array.prototype.slice.call(arguments); t.unshift(e); analytics.push(t); return analytics } }; for (var e = 0; e < analytics.methods.length; e++) { var key = analytics.methods[e]; analytics[key] = analytics.factory(key) } analytics.load = function (key, e) { var t = document.createElement("script"); t.type = "text/javascript"; t.async = !0; t.src = "https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js"; var n = document.getElementsByTagName("script")[0]; n.parentNode.insertBefore(t, n); analytics._loadOptions = e }; analytics._writeKey = "kxu54FZnPqGFfWYgOhHB4yMfph1ZWSWK";; analytics.SNIPPET_VERSION = "4.15.3";
                analytics.load("kxu54FZnPqGFfWYgOhHB4yMfph1ZWSWK");
            }
        }();
    </script>
    <script>
        var output = {}; //empty variable array
        var qs = document.location.search.substring(1); //get query string from url
        qs = qs.split('&'); //split at "&"

        //loop through each values in the above split and split at "="
        //Store into output array
        for (var i = 0; i < qs.length; i++) {
            var tokens = qs[i].split('=');
            output[tokens[0].toLowerCase()] = tokens[1];
        }
        //Remove object keys with empty values from output array
        //Store as "results"
        var results = Object.fromEntries(Object.entries(output).filter(value => value[1]))

        var has_utm = false //

        var smw1 = function ({ payload, next, integrations }) {
            console.log(payload)
            console.log(payload.obj.context.page.url)

            //check if utms are already set as traits in local storage - 
            //if yes set utm_exists to "true" and don't attach to payload
            // var utm_campaign_traits = analytics.user().traits().utm_campaign ? true : false
            // var utm_medium_traits = analytics.user().traits().utm_medium ? true : false
            // var utm_source_traits = analytics.user().traits().utm_source ? true : false

            // if (!(utm_campaign_traits && utm_medium_traits && utm_source_traits) && payload.obj.type == 'identify') {
            if (!analytics.user().traits().has_utm && payload.obj.type == 'identify') {
                payload.obj.traits.utm_campaign = results.utm_campaign
                payload.obj.traits.utm_medium = results.utm_medium
                payload.obj.traits.utm_source = results.utm_source
                payload.obj.traits.utm_exist = true
                has_utm = true
            };

            next(payload); //deliver the payload to Segment servers 

        };
        analytics.addSourceMiddleware(smw1); //activate/add the source middleware to ajs
        analytics.identify("97980cfea0067", {
            name: "Peter Gibbons",
            email: "peter@example.com",
            plan: "premium",
            utm_exist: has_utm
        });
    </script>
</head>

<body>
    <p>Testing UTM from payload as identify trait
    </p>
</body>

</html>